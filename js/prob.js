/**
 * @file porousCalculation.js
 * @author Minh Phuong, James Feracor,Charles W. Schwartz
 * @copyright Â© Pavia Systems 2017. All rights reserved.
 * Algorithm to determine Structural Number for Porous Pavement type
 */
function calculatePorous (asphaltSurface, q,a,deltaPsi,zR, sZero, esal,e1, e2, h1){
  var calculateSubgradeModulus = function(q, a,e1, e2, h1){
    var c = 0;
    var k = 0;
    var f2 = 0;

    var calculateF2 = function(c, k, h1, a){
      return c*(Math.pow((h1/a),k));
    };

    if (e1/e2 == 1) {
      f2 = calculateF2(1,0, h1, a);
    } else if(e1/e2 < 2 && e1/e2 > 1 ) {
      f2 = (calculateF2(0.78399,-0.17575, h1, a) + calculateF2(1,0, h1, a))/2;
    } else if(e1/e2 == 2) {
      f2 = calculateF2(0.78399,-0.17575, h1, a);
    } else if(e1/e2 < 5 && e1/e2 > 2 ) {
      f2 = (calculateF2(0.571671,-0.3855, h1, a) + calculateF2(0.78399,-0.17575, h1, a))/2;
    } else if(e1/e2 == 5 ) {
      f2 = calculateF2(0.571671,-0.3855, h1, a);
    } else if(e1/e2 < 10 && e1/e2 > 5 ) {
      f2 = (calculateF2(0.458323,-0.51515, h1, a) + calculateF2(0.571671,-0.3855, h1, a))/2;
    } else if(e1/e2 == 10) {
      f2 = calculateF2(0.458323,-0.51515, h1, a);
    } else if(e1/e2 < 20 && e1/e2 > 10) {
      f2 = (calculateF2(0.36976,-0.64697, h1, a) + calculateF2(0.458323,-0.51515, h1, a))/2;
    } else if(e1/e2 == 20) {
      f2 = calculateF2(0.36976,-0.64697, h1, a);
    } else if(e1/e2 < 50 && e1/e2 > 20) {
      f2 = (calculateF2(0.277553,-0.73309, h1, a) + calculateF2(0.36976,-0.64697, h1, a))/2;
    } else if(e1/e2 == 50) {
      f2 = calculateF2(0.277553,-0.73309, h1, a);
    } else if(e1/e2 < 100 && e1/e2 > 50) {
      f2 = (calculateF2(0.22016,-0.80628, h1, a) + calculateF2(0.277553,-0.73309, h1, a))/2;
    } else if(e1/e2 == 100) {
      f2 = calculateF2(0.22016,-0.80628, h1, a);
    } else if(e1/e2 < 200 && e1/e2 > 100) {
      f2 = (calculateF2(0.178131,-0.86336, h1, a)+ calculateF2(0.22016,-0.80628, h1, a))/2;
    } else if(e1/e2 == 200) {
      f2 = calculateF2(0.178131,-0.86336, h1, a);
    } else if(e1/e2 < 500 && e1/e2 > 200) {
      f2 = (calculateF2(0.136121,-0.90273, h1, a)+ calculateF2(0.178131,-0.86336, h1, a))/2;
    } else if(e1/e2 == 500) {
      f2 = calculateF2(0.136121,-0.90273, h1, a);
    } else if(e1/e2 < 1000 && e1/e2 > 500) {
      f2 = (calculateF2(0.109008,-0.92007, h1, a)+ calculateF2(0.136121,-0.90273, h1, a))/2;
    } else if(e1/e2 == 1000) {
      f2 = calculateF2(0.109008,-0.92007, h1, a);
    } else if(e1/e2 < 2000 && e1/e2 > 1000) {
      f2 = (calculateF2(0.085922,-0.94332, h1, a)+ calculateF2(0.109008,-0.92007, h1, a))/2;
    } else if(e1/e2 == 2000) {
      f2 = calculateF2(0.085922,-0.94332, h1, a);
    } else if(e1/e2 < 5000 && e1/e2 > 2000) {
      f2 = (calculateF2(0.062944,-0.96004, h1, a)+ calculateF2(0.085922,-0.94332, h1, a))/2;
    } else if(e1/e2 == 5000) {
      f2 = calculateF2(0.062944,-0.96004, h1, a);
    }

    var surfaceDeflection = 1.5*q*a*f2/e2;

    return 1.5*q*a/surfaceDeflection;
  };

  var compositeSubgradeModulus = calculateSubgradeModulus(q,a,e1, e2, h1);

  var calculationAASHTO = function(structuralNum){
  return  (zR*sZero)+9.36*(Math.log10(structuralNum+1)) - 0.2 + Math.log10(deltaPsi/2.7)/(0.4+(1094/Math.pow((structuralNum+1),5.19))) + 2.32*Math.log10(compositeSubgradeModulus) - 8.07 - Math.log10(esal);
  }

  var structuralNumFound = calculationAASHTO(Math.log10(esal));

  var derivativeAASHTO = function(structuralNum){
    return (234/25)*Math.log10(1+structuralNum)+(283893/50)*(1+structuralNum)^(-619/100)*(1094*(1+structuralNum)^(-519/100)+2/5)^(-2)*Math.log10(25/27);
  }

  while (Math.abs(calculationAASHTO(structuralNumFound)) >= 0.001){
    //Newton-Raphson method
    structuralNumFound = structuralNumFound - calculationAASHTO(structuralNumFound)/(derivativeAASHTO(structuralNumFound));
  }

  var thickness = structuralNumFound/asphaltSurface;
  return options ={
          structuralNum:structuralNumFound.toFixed(2),
          mR: compositeSubgradeModulus.toFixed(2),
          thickness: thickness.toFixed(2)
          };
};

/**
 * Enum for y-value(F2) and matrix for x value (E1/E2)
 * xValueMatrix[0] is the root E1/E2 value, start extrapolation only starting on xValueMatrix[1]
 * @readonly
 * @enum {number}
 */
var yValue= [0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1, 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 1.7, 1.8, 1.9, 2, 2.5, 3, 4, 5, 6, 8, 10, 12];
var xValueMatrix = [[1, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000], [2, 1.0000, 1.0000, 0.9923, 0.9695, 0.9399, 0.9255, 0.8972, 0.8631, 0.8499, 0.8176, 0.7926, 0.7744, 0.7508, 0.7335, 0.7223, 0.7057, 0.6895, 0.6789, 0.6736, 0.6582, 0.6531, 0.6331, 0.6091, 0.5860, 0.5637, 0.5406, 0.5213, 0.5059], [5, 1.0000, 1.0000, 0.9472, 0.8903, 0.8433, 0.7926, 0.7279, 0.6789, 0.6381, 0.6138, 0.5814, 0.5550, 0.5339, 0.5058, 0.4903, 0.4717, 0.4609, 0.4399, 0.4298, 0.4200, 0.3797, 0.3433, 0.3129, 0.2918, 0.2807, 0.2505, 0.2323, 0.2184], [10, 1.0000, 0.9770, 0.9183, 0.8433, 0.7450, 0.6789, 0.6091, 0.5637, 0.5298, 0.4980, 0.4609, 0.4332, 0.4071, 0.3917, 0.3710, 0.3569, 0.3407, 0.3303, 0.3177, 0.3104, 0.2721, 0.2442, 0.2108, 0.1891, 0.1750, 0.1518, 0.1361, 0.1244], [20, 1.0000, 0.9399, 0.8565, 0.7625, 0.6582, 0.5814, 0.5217, 0.4681, 0.4365, 0.4009, 0.3739, 0.3514, 0.3277, 0.3081, 0.2918, 0.2785, 0.2659, 0.2499, 0.2442, 0.2331, 0.1996, 0.1750, 0.1453, 0.1254, 0.1117, 0.0882, 0.0752, 0.0660], [50, 0.9255, 0.8239, 0.7057, 0.6283, 0.5176, 0.4434, 0.3947, 0.3514, 0.3252, 0.2987, 0.2764, 0.2578, 0.2423, 0.2277, 0.2124, 0.2027, 0.1920, 0.1819, 0.1750, 0.1683, 0.1409, 0.1216, 0.0964, 0.0813, 0.0707, 0.0553, 0.0462, 0.0398], [100, 0.8565, 0.7625, 0.6531, 0.5381, 0.4434, 0.3653, 0.3227, 0.2873, 0.2598, 0.2367, 0.2157, 0.1981, 0.1847, 0.1710, 0.1620, 0.1499, 0.1420, 0.1334, 0.1294, 0.1235, 0.1017, 0.0871, 0.0702, 0.0587, 0.0507, 0.0384, 0.0318, 0.0272], [200, 0.8239, 0.6895, 0.5381, 0.4265, 0.3514, 0.3010, 0.2638, 0.2331, 0.2124, 0.1935, 0.1750, 0.1607, 0.1499, 0.1387, 0.1294, 0.1225, 0.1143, 0.1074, 0.1017, 0.0979, 0.0794, 0.0675, 0.0523, 0.0427, 0.0363, 0.0273, 0.0222, 0.0187], [500, 0.7926, 0.6186, 0.4609, 0.3381, 0.2680, 0.2277, 0.1966, 0.1710, 0.1558, 0.1420, 0.1284, 0.1161, 0.1074, 0.1017, 0.0942, 0.0892, 0.0838, 0.0776, 0.0746, 0.0712, 0.0578, 0.0491, 0.0380, 0.0306, 0.0254, 0.0208, 0.0170, 0.0145], [1000, 0.7057, 0.4980, 0.3653, 0.2721, 0.2174, 0.1819, 0.1558, 0.1376, 0.1235, 0.1125, 0.1017, 0.0934, 0.0858, 0.0800, 0.0752, 0.0712, 0.0665, 0.0625, 0.0596, 0.0569, 0.0458, 0.0386, 0.0292, 0.0234, 0.0206, 0.0161, 0.0131, 0.0111], [2000, 0.6283, 0.4040, 0.2680, 0.2157, 0.1764, 0.1499, 0.1274, 0.1117, 0.0979, 0.0899, 0.0800, 0.0729, 0.0670, 0.0625, 0.0578, 0.0543, 0.0507, 0.0476, 0.0451, 0.0431, 0.0352, 0.0295, 0.0228, 0.0188, 0.0158, 0.0121, 0.0098, 0.0082], [5000, 0.4980, 0.3010, 0.2124, 0.1620, 0.1314, 0.1091, 0.0906, 0.0794, 0.0691, 0.0620, 0.0569, 0.0527, 0.0487, 0.0451, 0.0421, 0.0395, 0.0372, 0.0352, 0.0333, 0.0318, 0.0256, 0.0214, 0.0167, 0.0135, 0.0113, 0.0086, 0.0069, 0.0058], [10000, 0.3947, 0.2208, 0.1558, 0.1235, 0.0979, 0.0794, 0.0665, 0.0578, 0.0503, 0.0451, 0.0417, 0.0383, 0.0358, 0.0333, 0.0313, 0.0295, 0.0279, 0.0264, 0.0252, 0.0243, 0.0200, 0.0162, 0.0123, 0.0099, 0.0083, 0.0063, 0.0051, 0.0043]];
